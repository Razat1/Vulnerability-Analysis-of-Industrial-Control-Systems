<?php
session_start();
require_once "config.php";

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

class USER
{
 private $db;
        public function __construct()
 {
  $database=new db();
  $db=$database->dbconnection();
  $this->conn=$db;
 } 
 public function query($sql)
 {
  $stmt=$this->conn->prepare($sql);
  return $stmt;
 }
 public function lastid(){
     $stmt=$this->conn->lastInsertId();
  return $stmt; 
  }
 
 public function login($email,$password)
 {
   try
  {
 $stmt = $this->conn->prepare("SELECT * FROM employee WHERE email=:uemail");
   $stmt->execute(array(":uemail"=>$email));
   $userRow=$stmt->fetch(PDO::FETCH_ASSOC);
   
   if($stmt->rowCount() == 1)
   {
    if($userRow['IsActive']=="1")
    {
     if($userRow['password']==md5($password))
     {
      $_SESSION['btn_login'] = $userRow['EmployeeId'];
      return true;
     }
     else
     {
      header("Location: /index.php?error");
      exit;
     }
    }
    else
    {
     header("Location: /index.php?inactive");
     exit;
    } 
   }
   else
   {
    header("Location: /index.php?error");
    exit;
   }  
  }
  catch(PDOException $ex)
  {
   echo $ex->getMessage();
  }
 }
 
  public function redirect($url)
 {
  header("location:$url");
 }
  public function is_logged_in()
      {
        if(isset($_SESSION['btn_login']))
        {
        return true;
       }
      }
  public function register($Name,$Email,$password)
 {
  try{
	try{
		$password=md5($pass);
		$stmt=$this->conn->prepare("insert into employee (Name, email, password) values(:uName,:uEmail, u:upassword)");
		$stmt->bindparam(':uName',$Name);
		$stmt->bindparam(':uEmail',$email);
		$stmt->bindparam(':upassword',$password);
		$stmt->execute();
		return $stmt;
		}
	  catch(PDOException $e){echo "error:".$e->getMessage();}
		}
		
	
	require( 'C:\inetpub\wwwroot\PHPMailer-master\src\Exception.php');
		require 'C:\inetpub\wwwroot\PHPMailer-master\src\PHPMailer.php';
		require 'C:\inetpub\wwwroot\PHPMailer-master\src\SMTP.php';
$mail = new PHPMailer(true);

$mail->isSMTP();
$mail->Mailer = "smtp";
// $mail->SMTPDebug=TRUE;
$mail->Host = "smtp.gmail.com";
$mail->Port = 587;

$mail->SMTPSecure = "tls";
$mail->SMTPAuth = true;
$mail->Username = "11.testproject1@gmail.com"; //Enter your gmail id
$mail->Password = "test_project11"; //Enter your gmail password
$mail->SetFrom("11.testproject1@gmail.com"); //Enter your gmail id
$mail->addAddress("$email");
$mail->IsHTML(true);
$mail->Subject = "Reset Password";//to do - create new email for this
$mail->Body = "<a href ='http://localhost:8888/reset_password.php?email=11.testproject1@gmail.com'> Reset Password</a>";
try {
	$mail->send();
	echo "Message has been sent successfully";
} catch (Exception $e) {
	echo "Mailer Error: " . $mail->ErrorInfo;
}
}
?>