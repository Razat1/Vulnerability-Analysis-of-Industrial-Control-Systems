<?php
require('config.php');

session_start();
foreach (getallheaders() as $name => $value) {
    echo "$name: $value\n";
}
foreach ($_POST as $key => $value) {
    echo "Field " . htmlspecialchars($key) . " is " . htmlspecialchars($value) . "<br>";
}



if (isset($_SESSION["user_login"]))    //check condition user login not direct back to index.php page
{
    header("location: welcome.php"); //what is this????????
}

if (isset($_REQUEST['btn_login']))    //button name is "btn_login" 
{
    $email = $_POST['txt_email'];
    $password = $_POST['txt_password'];
    $role = $_POST['txt_role'];
    $attempt;
    $createddate;

    if (empty($email)) {
        $errorMsg[] = "Please enter email";
    } else if (empty($password)) {
        $errorMsg[] = "Please enter password";
    } else if (empty($role)) {
        $errorMsg[] = "Please select role";
    } else {

        // echo "here";

        // echo "here2 email=$email, password=$password, role=$role";

        try {
            // echo "here3";
            $select_stmt = $db->prepare("SELECT * FROM employee WHERE email=:uemail AND password=:upassword AND role=:urole");
            //echo "herea";
            $select_stmt->execute(array(':uemail' => $email, ':upassword' => $password, ':urole' => $role));
            // echo "hereb";
            $row = $select_stmt->FETCH(PDO::FETCH_ASSOC);
            // echo "here4";
            $rowcount = $select_stmt->rowCount();
            // print_r("Hi Raaz: $rowcount");

            if ($select_stmt->rowCount() > 0) {
                $e = $row["Email"];
                $p = $row["password"];
                $r = $row["Role"];
                // print_r("Hi Raaz: $p, $e, $r");

                if ($email === $row["Email"] and $role === $row["Role"]) {
                    // echo "matched";

                    $_SESSION["btn_login"] = $row["EmployeeId"];
                    $loginMsg = "successful login";
                    // echo "logged in\n";
                    switch ($role) {
                        case "admin":
                            $_SESSION["admin_login"] = $email;
                            $loginMsg = "Successful Admin login, Welcome!";
                            header("refresh:3;/admin_home.php"); //change to my directory
                            break;

                        case "employee":
                            $_SESSION["employee_login"] = $email;
                            $loginMsg = "Successful Employee login, Welcome!";
                            header("refresh:3;/employee_home.php"); //change to my directory
                            break;

                        default:
                            $errorMsg[] = "wrong Role";
                    }
                }
            } else {
                $errorMsg[] = "wrong email or password, Try Again";
               
                    if (empty($_SESSION['ip'])) {
                      $_SESSION['ip'] = $_SERVER['REMOTE_ADDR'];
                      $_SESSION['numTries'] = 1;
                    }
                    else {
                      if ($_SERVER['REMOTE_ADDR'] === $_SESSION['ip']) {
                        $_SESSION['numTries'] += 1;
                      }
                      else {
                        $_SESSION['ip'] = $_SERVER['REMOTE_ADDR'];
                        $_SESSION['numTries'] = 1;
                      }
                    }
                    sleep(pow(2,$_SESSION['numTries']));
                    $loggedIn = FALSE;
                  }
                }
                //
                $select_stmt = $db->prepare("INSERT INTO account_lock ('CreatedDate', 'Attempt') VALUES ( ?, ? )");
                echo "herea";
                //$select_stmt->execute(array(':uattempt' => $attempt, ':ucreateddate' => $createddate));
                // echo "hereb";
                //$row = $select_stmt->FETCH(PDO::FETCH_ASSOC);
                 echo "here4";
                $rowcount = $select_stmt->rowCount();
                if ($select_stmt->rowCount() < 0) {
                    $a = $row["Attempt"];
                    $c = $row["CreatedDate"];
                    
                 print_r("Hi Raaz: $a, $c");
    
                    if ($email != $row["Email"] and $role != $row["Role"]) {
                        // echo "matched";
    
                        $_SESSION['numTries'] += 1;
                        //$loginMsg = "unsuccessful login";
                        
            }
        }
    }
            
        } catch (PDOException $e) {

            $errorMsg = $e->getMessage();
            echo "got an error : $errorMsg";
        }
    }
}

?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
</head>

<body>

    <form method="post" class="form-horizontal">

        <div class="form-group">
            <label class="col-sm-3 control-label">Email</label>
            <div class="col-sm-6">
                <input type="text" name=txt_email class="form-control" placeholder="enter email">
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">Password</label>
            <div class="col-sm-6">
                <input type="text" name=txt_password class="form-control" placeholder="enter password">
            </div>
        </div>
        <div class="form-group">
            <label for="col-sm-3 control label">Select Type</label>
            <div class="col-sm-6">
                <select class="form-control" name="txt_role">
                    <option value='' selected="selected"> - select role - </option>
                    <option value="admin">Admin</option>
                    <option value="employee">Employee</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-3 col-sm-9 m-t-15"></div>
            <input type="submit" name="btn_login" class="btn btn-success" value="login">
        </div>
        <div class=form-group>
            <div class="col-sm-offset-3 col-sm-9 m-t-15">
                <p><a href="forgotindex.php" name="btn_forgot" class="btn btn-success">Forgot Password</a></p>
            </div>
        </div>


    </form>
    <div style="color: red">
        <?php
        // echo "raz: starting error block\n";
        if (isset($errorMsg)) {
            foreach ($errorMsg as $error) {
                echo $error;
            }
        } else {
            // echo "raz: no error msg\n";
        }
        if (isset($loginMsg)) {
            echo $loginMsg;
        }
        ?>
    </div>
    </div>
    </div>
    </div>
</body>

</html>