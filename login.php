<?php
require('config.php');


session_start();
foreach (getallheaders() as $name => $value) {
    echo "$name: $value\n";
}
foreach ($_POST as $key => $value) {
    echo "Field ".htmlspecialchars($key)." is ".htmlspecialchars($value)."<br>";
}



if(isset($_SESSION["user_login"]))	//check condition user login not direct back to index.php page
{
	header("location: welcome.php");
}

if(isset($_REQUEST['btn_login']))	//button name is "btn_login" 
{ 

    echo "here";
    $email = $_POST['txt_email'];
        $password = $_POST['txt_password'];
        $role=$_POST['txt_role'];

        echo "here2 email=$email, password=$password, role=$role";
	// $username	=strip_tags($_REQUEST["txt_username_email"]);	//textbox name "txt_username_email"
	// $email		=strip_tags($_REQUEST["txt_username_email"]);	//textbox name "txt_username_email"
	// $password	=strip_tags($_REQUEST["txt_password"]);			//textbox name "txt_password"
		
	// if(empty($username)){						
	// 	$errorMsg[]="please enter username or email";	//check "username/email" textbox not empty 
	// }
	// else if(empty($email)){
	// 	$errorMsg[]="please enter username or email";	//check "username/email" textbox not empty 
	// }
	// else if(empty($password)){
	// 	$errorMsg[]="please enter password";	//check "passowrd" textbox not empty 
	// }
	// else
	// {
        try{
            echo "here3";
            $select_stmt=$db->prepare("SELECT * FROM employee WHERE email=:uemail AND password=:upassword AND role=:urole");
            echo "herea";
    // $select_stmt = $db->prepare("SELECT * FROM employee WHERE email='$email' and password='$password' and role='$role' ");
    $select_stmt->execute(array(':uemail'=>$email, ':upassword'=>$password, ':urole'=>$role));
    echo "hereb";
    $row=$select_stmt->FETCH(PDO::FETCH_ASSOC);
    echo "here4";
    $rowcount= $select_stmt->rowCount();
    print_r("Hi Raaz: $rowcount");
    
    if($select_stmt->rowCount()>0)
    {   
        $e =$row["Email"];
        $p =$row["password"];
        $r =$row["Role"];
        print_r("Hi Raaz: $p, $e, $r");

        if($email===$row["Email"] AND $role===$row["Role"]){
            echo "matched";
            if($password===$row["password"]){
                
                $_SESSION["btn_login"]=$row["EmployeeId"];
                $loginMsg ="successful login";
                echo "logged in\n";

            }
           //uncomment this after password is encrypted
            // if(password_verify($password,$row["password"])){
            //     $_SESSION["btn_login"]=$row[EmployeeId];
            //     $loginMsg ="successful login";

            // }
        }
        
  // $data=$select->fetch();
    // print_r("Hi Raaz: $data");
    // $admin = "admin/ham123";
    // $admin = "admin";

// if(isset($_SESSION["admin_login"])) //checks condition admin login
// {
//     header("location: /admin_home.php");
// }

// else if(isset($_SESSION["employee_login"])) //checks condition admin login
// {
//     header("location: /employee_home.php");
// }

// if(isset($_REQUEST["btn_login"])) //login button name
// {
//     $email =$_REQUEST["txt_email"];
//     $email= $_REQUEST["txt_password"];
//     $role= $_REQUEST["txt_role"];
// }
		//user login success message
				// 		header("refresh:2; welcome.php");			//refresh 2 second after redirect to "welcome.php" page
				// 	}
				// 	else
				// 	{
				// 		$errorMsg[]="wrong password";
				// // 	}
				// // }
				// else
				// {
				// 	$errorMsg[]="wrong username or email";
				// }
			}
			else
			{
				$errorMsg[]="wrong username or email";
			}
		}
		catch(PDOException $e)
		{
            
			$errorMsg= $e->getMessage();
            echo "got an error : $errorMsg";

		}		
	}



// if(empty($email)){
//     $errorMsg[]="Please enter email";
// }

// if(empty($password)){
//     $errorMsg[]="Please enter password";
// }

// if(empty($role)){
//     $errorMsg[]="Please select role";
// }

// else if($email AND $password AND $role)
// {
//     try{
//         $select_stmt=$dbh->prepare("SELECT * FROM employee WHERE Email='$email' and Password='$password' and Role = $role");

//         $select_stmt->bindParam(":uemail" ,$email);
//         $select_stmt->bindParam(":upassword",$password);
//         $select_stmt->bindParam(":urole",$role);
//         $select_stmt->execute();

//         while($row=$select_stmt->fetch(PDO::FETCH_ASSOC))
//         {
//             $dbemail =$row["email"];
//             $dbpassword =$row["password"];
//             $dbrole =$row["role"];
//         }
//         if($email!==null AND $password!==null AND $role!==null){
//         if ($select_stmt->rowCount()>0)  
//         if($email==$dbemail AND $password==$dbpassword AND $dbrole==$dbrole)
//         {
//             switch($dbrole)
//             {
//               case"admin":
//                 $_SESSION["admin_login"]=$email;
//                 $loginMsg="Successful Admin login, Welcome!";
//                 header("refresh:3;/admin_home.php"); //change to my directory
//                 break;

//                 case"employee":
//                     $_SESSION["employee_login"]=$email;
//                     $loginMsg="Successful Employee login, Welcome!";
//                     header("refresh:3;/employee_home.php"); //change to my directory
//                     break;
                
//                default:
//                $errorMsg[]="wrong email or pass or role";     
//             }
//         }

//         else{
//             $errorMsg[]="wrong email or password or role";
//         }
//     }

    
//     else{
//         $errorMsg[]="wrong email or password or role";
//     }
// }

//         catch(PDOException $e)
//           {
//               $e->getMessage();
//          }
//        }


//       else{
//     $errorMsg[]="wrong email or password or role";
//      }

