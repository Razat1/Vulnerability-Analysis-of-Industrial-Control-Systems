<?php
require_once 'config.php';
$user = new USER();

if(empty($_GET['userID']) && empty($_GET['mdcode']))
{
 $user->redirect('index.php');
}

if(isset($_GET['userID']) && isset($_GET['mdcode']))
{
 $id = base64_decode($_GET['userID']);
 $code = $_GET['mdcode'];
 $stmt = $user->query("SELECT * FROM users WHERE userID=:uid AND mdcode=:code");
 $stmt->execute(array(":uid"=>$id,":code"=>$code));
 $rows = $stmt->fetch(PDO::FETCH_ASSOC);
 if($stmt->rowCount() == 1)
 {
  if(isset($_POST['resetpass']))
  {
   $pass = $_POST['pass'];
   $cpass = $_POST['confirm-pass'];
   
   if($cpass!==$pass)
   {
    $msg = " <strong>Sorry!</strong>  Password Mismatch. ";
   }
   else
   {
    $stmt = $user->query("UPDATE users SET userPass=:upass WHERE userID=:uid");
    $stmt->execute(array(":upass"=>$cpass,":uid"=>$rows['userID']));
    
    $msg = "Password Changed.";
    header("refresh:5;index.php");
   }
  } 
 }
 else
 {
  exit;
 }
 }

?>
<!DOCTYPE html>
<html>
  <head>
    <title>Password Reset</title>
  </head>
  <body >
  <div>
  <strong>Hello !</strong>  <?php echo $rows['userEmail'] ?> you are here to reset your forgetton password.
  </div>
        <form method="post">
        <h3>Password Reset.</h3><hr />
        <?php
        if(isset($msg))
  {
   echo $msg;
  }
  ?>
        <input type="password" placeholder="New Password" name="pass" required />
        <input type="password" placeholder="Confirm New Password" name="confirm-pass" required />
        <button type="submit" name="resetpass">Reset Your Password</button>
        
      </form>
  </body>
</html>